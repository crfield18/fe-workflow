#!/bin/bash

##########################################
pathhere=`pwd`
path=/run/media/abir/hdd1/work/afe/workflow/cdk2_set4/try
pathTOWFToolKit=/run/media/abir/hdd1/work/afe/workflow/clean_10282021
pathTOFEToolKit=/home/abir/devel/git/AMBER_DD_BOOST/FE-ToolKit
export PATH="$PATH:${pathTOWFToolKit}/bin"
###########################################

##########################################
# load modules
source ${pathTOWFToolKit}/bin/function-read_input.sh 					# read input file
source ${pathTOWFToolKit}/bin/function-parse_input.sh					# parse input file
source ${pathTOWFToolKit}/bin/function-gen_lambda.sh					# generate lambda values
source ${pathTOWFToolKit}/bin/function-write_template_rbfe.sh				# template for rbfe calculations
source ${pathTOWFToolKit}/bin/function-write_template_rsfe.sh				# template for rsfe calculations
source ${pathTOWFToolKit}/bin/function-createbox.sh
source ${pathTOWFToolKit}/bin/function-preparePDBs.sh
source ${pathTOWFToolKit}/bin/function-analyze.sh


###########################################
# Main program

# change to working directory
cd $path

	#read and parse input data
	parse_input $1

	# initial array initialization
	for i in "${!translist[@]}";do
		stA=$(basename ${translist[$i]}); stB="${stA##*~}"; stA="${stA%~*}"
		listA+=("${stA}"); listB+=("${stB}")
	done
	listligs+=(${listA[@]} ${listB[@]})
	uniqueligs=($(echo "${listligs[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))

	#################################
	##BEGIN STAGE=setup
	if [ "$stage" == "setup" ]; then
	#################################
	
		mkdir -p ${system}/setup

		# File Organization
		source ${pathTOWFToolKit}/bin/section-FileOrganization.sh

		# Atom Mapping
		source ${pathTOWFToolKit}/bin/section-AtomMapping.sh

		# Construction of MD boxes
		source ${pathTOWFToolKit}/bin/section-MDboxes.sh

		# setup mode 0 correspond to regular TI setup
		if [ "${setupmode}" == 0 ]; then
			source ${pathTOWFToolKit}/bin/section-setupmodezero.sh
		fi
		# END of setupmode=0

		# setup mode 1 correspond to end-point ACES setup
		if [ "${setupmode}" == 1 ]; then
			source ${pathTOWFToolKit}/bin/section-setupmodeone.sh
		fi
		# END of setupmode=0
	#################################
	##END STAGE=setup
	fi
	#################################

	#################################
	##BEGIN STAGE=analysis
	if [ "$stage" == "analysis" ]; then
	#################################
		source ${pathTOWFToolKit}/bin/section-analysis.sh
	#################################
	##END STAGE=check-TI
	fi
	#################################
cd $pathhere

